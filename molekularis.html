<!DOCTYPE html>
<html style="width: 100%; height: 100%" >
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.png" />
    <title>Molekularis</title>
</head>
<body style="width: 100%; height: 100%; margin: 0pt">
<canvas id="canvas" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0;"></canvas>
<script>

var width, height;
var canvas = document.getElementById("canvas");
var ctx, update;

function resize() {
    width = document.body.clientWidth;
    canvas.width = width;
    height = document.body.clientHeight;
    canvas.height = height;
    update(width, height, 0, 0, -1);
}

function click(event) {
    event.preventDefault();
    update(width, height, event.clientX, event.clientY, event.button);
    return false;
}

function clear(r, g, b) {
    ctx.fillStyle = "rgb(" + r + ", " + g + ", " + b + ")"
    ctx.fillRect(0, 0, width, height);
}

function draw_line(x0, y0, x1, y1, thickness) {
    ctx.lineWidth = thickness;
    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.lineTo(x1, y1);
    ctx.stroke();    
}


function draw_dot(x, y) {
    ctx.beginPath();
    ctx.arc(x, y, 0.8, 0, 2*Math.PI);
    ctx.fill();    
}


function draw_char(x, y, c) {
    ctx.font = '18px serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.fillStyle = 'rgb(0, 0, 0)';
    ctx.fillText(String.fromCharCode(c), x, y - 7);
}

function ignore(event) {
    event.preventDefault();
    return false;
}

async function init() {
    const { instance } = await WebAssembly.instantiateStreaming(
        fetch("./molekularis.wasm"),
        { env: { clear, draw_line, draw_char, draw_dot } }
    );

    puzzle_text = `              O-N              
             /   \\             
          O-N     N-N          
         /   \\   /   \\         
      N-C     C-C     C-N      
     /   \\   /   \\   /   \\     
  N-N     O-O     O-N     O-N  
 /   \\   /   \\   /   \\   /   \\ 
O     N-N     C-O     O-O     N
 \\   /   \\   /   \\   /   \\   / 
  O-O     O-C     N-O     O-O  
 /   \\   /   \\   /   \\   /   \\ 
O     O-O     O-N     O-C     O
 \\   /   \\   /   \\   /   \\   / 
  N-O     O-O     O-N     N-O  
 /   \\   /   \\   /   \\   /   \\ 
O     N-N     N-O     N-O     N
 \\   /   \\   /   \\   /   \\   / 
  O-O     O-C     N-N     O-N  
 /   \\   /   \\   /   \\   /   \\ 
O     O-N     O-N     O-O     N
 \\   /   \\   /   \\   /   \\   / 
  N-N     N-O     C-O     N-O  
     \\   /   \\   /   \\   /     
      C-C     N-N     N-O      
         \\   /   \\   /         
          O-O     N-N          
             \\   /             
              O-O              
`;
    
    const array = new Uint8Array(
      instance.exports.memory.buffer,
      instance.exports.puzzle_text,
      puzzle_text.length
    );
    const textEncoder = new TextEncoder();
    array.set(textEncoder.encode(puzzle_text));
    instance.exports.init(array.length);

    update = instance.exports.update;

    if (canvas.getContext) {
        ctx = canvas.getContext('2d');
        resize();
        canvas.addEventListener("click", click);
        canvas.addEventListener("contextmenu", ignore);
        canvas.addEventListener("auxclick", click);
        window.addEventListener("resize", resize);
        document.onkeydown = function(event) {
            if(event.key == "y" || event.key == "z") {
                instance.exports.undo();
                update(width, height, 0, 0, -1);
            }
        };
    }

}
init();
</script>






</body>